version: '2.4'

services:

  consul-agent-1: 
    image: consul:latest
    environment:
    - CONSUL_BIND_INTERFACE=eth0
    networks:
      consul-dc2:
        ipv4_address: 10.0.2.3
    command: "agent -retry-join consul-server-bootstrap -datacenter dc2 -client 0.0.0.0"

  # consul-agent-2:
  #   <<: *consul-agent

  # consul-agent-3:
  #   <<: *consul-agent

  consul-server-1: 
    image: consul:latest
    environment:
    - CONSUL_BIND_INTERFACE=eth0
    networks: 
      consul-dc2:
        ipv4_address: 10.0.2.11
    command: "agent -server -retry-join consul-server-bootstrap -client 0.0.0.0 -datacenter dc2  -advertise-wan=10.0.2.11"

  consul-server-2:
    image: consul:latest
    environment:
    - CONSUL_BIND_INTERFACE=eth0
    networks: 
      consul-dc2:
        ipv4_address: 10.0.2.12
    command: "agent -server -retry-join consul-server-bootstrap -client 0.0.0.0 -datacenter dc2  -advertise-wan=10.0.2.12"

  consul-server-bootstrap:
    image: consul:latest
    environment:
    - CONSUL_BIND_INTERFACE=eth0
    networks: 
      consul-dc2:
        ipv4_address: 10.0.2.13
    ports:
      - "8502:8500"
    command: "agent -server -bootstrap-expect 3 -ui -client 0.0.0.0 -datacenter dc2 -retry-join-wan=10.0.1.13 -advertise-wan=10.0.2.13"

networks:
  consul-dc2:
    ipam:
      driver: default
      config:
      - subnet: "10.0.2.0/24"